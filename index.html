<script type="module">
  import { GoogleGenerativeAI } from "@google/generative-ai";

  // 1. CONFIGURACIÃ“N
  // AsegÃºrate de que esta API Key sea la de Google AI Studio (la que empieza con AIza...)
  const API_KEY = "TU_API_KEY_DE_GEMINI_AQUI"; 
  const genAI = new GoogleGenerativeAI(API_KEY);

  // 2. REFERENCIAS AL DOM
  const btnIA = document.getElementById('btnIA');
  const resultadoIA = document.getElementById('resultadoIA');
  const listaPasos = document.getElementById('listaPasos');
  const contenedorTips = document.getElementById('contenedorTips');

  // 3. FUNCIÃ“N PRINCIPAL
  btnIA.addEventListener('click', async () => {
    
    // A) Obtener Nombre del Plato (Usando tu ID correcto)
    const nombrePlatoInput = document.getElementById('recipeName');
    const nombrePlato = nombrePlatoInput.value.trim() || "Plato Sorpresa";
    
    // B) Recolectar Ingredientes (Usando tus clases especÃ­ficas)
    // Buscamos cada fila y extraemos nombre, cantidad y unidad
    const filasIngredientes = document.querySelectorAll('.ingredient-row');
    let listaIngredientes = [];

    filasIngredientes.forEach(fila => {
        const nombre = fila.querySelector('.ing-name').value.trim();
        const cantidad = fila.querySelector('.ing-qty').value.trim();
        const unidad = fila.querySelector('.ing-unit').value.trim();

        // Solo agregamos si tiene nombre
        if(nombre) {
            // Formato legible para la IA: "200 gr de Harina"
            listaIngredientes.push(`${cantidad} ${unidad} de ${nombre}`);
        }
    });

    if (listaIngredientes.length === 0) {
        alert("Â¡Agrega al menos un ingrediente para que el chef pueda trabajar!");
        return;
    }

    // UI: Mostrar estado de carga
    const textoOriginal = btnIA.textContent;
    btnIA.textContent = "ðŸ³ El Chef estÃ¡ pensando...";
    btnIA.disabled = true;
    btnIA.style.opacity = "0.7";
    resultadoIA.style.display = 'none';

    try {
      // 4. PREPARAR EL MODELO
      const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

      const prompt = `
        ActÃºa como un chef experto y amigable. 
        Voy a cocinar: "${nombrePlato}".
        
        Tengo estos ingredientes exactos: 
        ${listaIngredientes.join(", ")}.
        
        Por favor genera:
        1. Un procedimiento paso a paso numerado (lÃ³gico y claro).
        2. Tres "secretos" o tips cortos (trucos de sabor, tÃ©cnica o emplatado).

        IMPORTANTE: Devuelve la respuesta SOLO en formato JSON puro, sin bloques de cÃ³digo markdown, con esta estructura exacta:
        {
          "pasos": ["Paso 1...", "Paso 2..."],
          "tips": [
            {"titulo": "TITULO CORTO", "contenido": "Consejo breve..."},
            {"titulo": "TITULO CORTO", "contenido": "Consejo breve..."}
          ]
        }
      `;

      // 5. LLAMADA A LA IA
      const result = await model.generateContent(prompt);
      const response = await result.response;
      let text = response.text();
      
      // Limpieza robusta del JSON (quita ```json y ```)
      text = text.replace(/```json/g, "").replace(/```/g, "").trim();
      
      const data = JSON.parse(text);

      // 6. MOSTRAR RESULTADOS
      // Limpiar anteriores
      listaPasos.innerHTML = "";
      contenedorTips.innerHTML = "";

      // Renderizar Pasos
      data.pasos.forEach(paso => {
          const li = document.createElement('li');
          li.textContent = paso;
          li.className = "mb-2 text-gray-700 font-serif text-lg"; // Un poco de estilo Tailwind
          listaPasos.appendChild(li);
      });

      // Renderizar Tips (Estilo Post-it mejorado)
      data.tips.forEach(tip => {
          const div = document.createElement('div');
          // Estilos inline para asegurar que se vean bien las tarjetas
          div.className = "flex-shrink-0 w-64 p-4 rounded-lg shadow-md transform hover:-translate-y-1 transition-transform duration-200";
          div.style.backgroundColor = "#fffef0"; // Color papel
          div.style.border = "1px solid #e2e8f0";
          
          div.innerHTML = `
            <div class="font-bold text-red-500 mb-2 border-b border-red-200 pb-1">ðŸ“Œ ${tip.titulo}</div>
            <p class="text-gray-600 text-sm leading-relaxed">${tip.contenido}</p>
          `;
          contenedorTips.appendChild(div);
      });

      resultadoIA.style.display = 'block';
      // Auto-scroll suave hacia el resultado
      resultadoIA.scrollIntoView({ behavior: 'smooth', block: 'start' });

    } catch (error) {
      console.error("Error IA:", error);
      alert("El chef tuvo un problema tÃ©cnico. Revisa la consola (F12) para ver el detalle.");
    } finally {
      // Restaurar botÃ³n
      btnIA.textContent = textoOriginal;
      btnIA.disabled = false;
      btnIA.style.opacity = "1";
    }
  });
</script>
